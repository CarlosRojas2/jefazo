events {
    # Número de conexiones de trabajo
    worker_connections 1024;
}

http {
    # Configuración base
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 100M; # Aumentar si necesitas subir archivos grandes

    server {
        # 1. PUERTO PÚBLICO: Escucha en el puerto 8080 (el puerto que Railway expone)
        listen 8080;
        
        # 2. RAÍZ DEL PROYECTO: Apunta al directorio público de Laravel
        root /var/www/public;
        
        index index.php index.html index.htm;

        # 3. CONTROLADOR LARAVEL: Envía todas las peticiones a index.php (Fronter Controller)
        location / {
            # Si el archivo/directorio no existe, usa index.php como controlador
            try_files $uri $uri/ /index.php?$query_string;
            
            # Headers para permitir acceso a cámara
            add_header Permissions-Policy "camera=*";
        }

        # 4. PASO A PHP-FPM: Configuración para procesar archivos PHP
        location ~ \.php$ {
            # Deshabilita el manejo de archivos que no sean PHP
            try_files $uri =404;
            
            # CRUCIAL: Pasa la solicitud al puerto donde PHP-FPM está escuchando
            fastcgi_pass 127.0.0.1:9000;
            
            # Directorio del script PHP
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            
            # --- SOLUCIÓN MIXED CONTENT (HTTPS) ---
            # 1. Fuerza a Laravel a reconocer que la conexión es HTTPS
            fastcgi_param HTTPS on; 
            
            # 2. Pasa el protocolo (https) y el host original al backend de PHP
            fastcgi_param HTTP_X_FORWARDED_PROTO $scheme; 
            fastcgi_param HTTP_HOST $host; 
            # ------------------------------------
            
            include fastcgi_params;
        }

        # 5. SEGURIDAD: Denegar acceso a archivos ocultos (opcional pero recomendado)
        location ~ /\.ht|/\.env {
            deny all;
        }
    }
}